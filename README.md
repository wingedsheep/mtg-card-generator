# MTG Card Generator

Generate complete Magic: The Gathering card sets using AI, including card mechanics, flavor text, and artwork. The generator creates thematically cohesive sets with synergistic mechanics based on randomly generated themes or your own custom themes.

## Features

- **Theme Options**: Either generate unique, cohesive themes automatically or provide your own complete theme override.
- **Card Generation**: Generates complete cards including:
  - Card names and mana costs
  - Card types and abilities
  - Power/toughness for creatures
  - Flavor text
  - Rarity distribution
  - Color balance
- **Art Generation**: Creates unique artwork for each card using AI.
  - Supports Replicate API (default).
  - **New:** Supports local image generation via Hugging Face `diffusers` library (requires local setup and powerful GPU).
- **Language Model Integration**:
  - Uses OpenRouter API for card text, theme, and JSON conversion (default).
  - **New:** Supports local language model interaction via Ollama (requires local Ollama setup and downloaded models).
- **Card Rendering**: Renders cards in the official MTG card frame style.
- **Format Support**: Outputs cards in both JSON and PNG formats.
- **Tabletop Simulator Support**: Convert card images into properly formatted deck sheets for Tabletop Simulator.
- **Booster Draft Generator**: Create draft boosters with the correct card distribution for play in Tabletop Simulator.

## Generated example Cards

Here are some examples of cards generated by the system:

![Example Card 1](example-cards/example1.png)
![Example Card 2](example-cards/example2.png)
![Example Card 3](example-cards/example3.png)

## Prerequisites

- Python 3.8+
- Node.js (for running the card renderer)
- A modern web browser
- API keys (required):
  - OpenRouter API key (for card generation)
    - Sign up at https://openrouter.ai/
    - Create an account and generate an API key
    - This is used for generating card mechanics, flavor text, and converting card formats
  - Replicate API key (for art generation)
    - Sign up at https://replicate.com/
    - Create an account and generate an API key from your account settings
    - This is used for generating unique artwork for each card using AI models
  - **(Optional) Hugging Face Diffusers**: For local image generation.
    - No API key needed, but requires a local environment with `diffusers`, `torch`, and compatible GPU.
    - See `card-generator/tools/huggingface_diffusers_tool.py` for more details.
  - **(Optional) Ollama**: For local language model usage.
    - No API key needed, but requires a local Ollama installation and downloaded models (e.g., Llama 2, Mistral).
    - See `card-generator/tools/ollama_tool.py` for more details.
    - Ollama website: https://ollama.com/
  
Note: OpenRouter and Replicate APIs require credit card information and have associated costs.
- OpenRouter charges based on the number of tokens processed.
- Replicate charges based on the number of images generated.

Using local models via Hugging Face Diffusers and Ollama can be free alternatives (after initial hardware setup for Diffusers) but may require significant local compute resources and technical setup. The project defaults to paid APIs for ease of use and potentially higher quality out-of-the-box.

## Installation

1. Clone the repository:
```bash
git clone https://github.com/yourusername/mtg-card-generator.git
cd mtg-card-generator
```

2. Create and activate a virtual environment:
```bash
# On Linux/Mac
python -m venv venv
source venv/bin/activate

# On Windows
python -m venv venv
venv\Scripts\activate
```

3. Install Python dependencies:
```bash
pip install -r requirements.txt
```

4. Install Playwright browser:
```bash
playwright install
```

5. Configure API keys:
```bash
# Copy the example settings file
cp card-generator/settings.example.json card-generator/settings.json

# Edit settings.json with your API keys
{
  "openrouter": {
    "apiKey": "your_openrouter_api_key"
  },
  "replicate": {
    "apiKey": "your_replicate_api_key"
  }
}
```

## Usage

1. Start the card generation process:
```bash
cd card-generator
python main.py
```

This will:
- Generate a random set theme (or use your provided theme)
- Create cards with balanced colors and rarities
- Generate art for each card
- Convert cards to the proper rendering format
- Render cards as images

2. The generated content will be in the `output` directory:
- `mtg_set_output.json`: Raw card data
- `mtg_set_complete.json`: Complete set data with statistics
- `render_format/`: Cards formatted for rendering in `card-rendering/index.html`
- `card_images/`: Final rendered card images

3. To manually render individual cards:
```bash
cd card-rendering
# Open index.html in a web browser
```

## Configuration

Configuration is primarily managed through `card-generator/settings.json`. You should copy `card-generator/settings.example.json` to `card-generator/settings.json` and customize it.

The `settings.json` file allows you to:
-   Set API keys for OpenRouter and Replicate.
-   Define global API headers.
-   Choose strategies for image generation (e.g., "replicate", "diffusers") and language models (e.g., "openrouter", "ollama").
-   Configure specific parameters for each strategy and model, such as model IDs, API endpoints, device preferences (cuda/cpu), image dimensions, and language model parameters (temperature, max tokens).
-   Set operational parameters for card set generation, including:
    -   `inspiration_cards_count`
    -   `batches_count`
    -   `theme_prompt` (for AI-generated themes)
    -   `complete_theme_override` (to provide your own full theme text)
    -   `generate_basic_lands` and `land_variations_per_type`
    -   Rarity distribution per batch (`rarities_per_batch`)
    -   Target color distribution (`color_distribution_targets`)

**Example `settings.json` Structure:**

```json
{
  "api_keys": {
    "openrouter": "YOUR_OPENROUTER_KEY",
    "replicate": "YOUR_REPLICATE_KEY"
  },
  "api_headers": { /* ... */ },
  "output_directory_base": "output_sets",

  "image_generation": {
    "strategy": "replicate", // "replicate" or "diffusers"
    "default_output_dir_name": "card_images",
    "replicate": {
      "selected_model_type": "flux", // "flux" or "imagen"
      "models": {
        "flux": { "id": "black-forest-labs/FLUX.1-schnell", "params": { /* ... */ } },
        "imagen": { "id": "ai-forever/kandinsky-2.2", "params": { /* ... */ } }
      },
      "cropping": { /* ... */ }
    },
    "diffusers": {
      "model_id": "runwayml/stable-diffusion-v1-5",
      "device": "cuda",
      "params": { /* e.g., num_inference_steps */ },
      "dimensions": { /* standard_width, saga_height etc. */ }
    }
  },

  "language_model": {
    "strategy": "openrouter", // "openrouter" or "ollama"
    "openrouter": {
      "base_url": "https://openrouter.ai/api/v1",
      "models": { // Role-based model selection
        "default_main": "openai/gpt-4o",
        "default_json": "openai/gpt-4o-mini",
        "art_prompt_generation": "openai/gpt-4o",
        /* ... other roles ... */
      },
      "params": { /* Default OpenRouter params */ }
    },
    "ollama": {
      "host": null, // Defaults to local Ollama
      "models": { /* Role-based model selection for Ollama */ },
      "params": { /* Default Ollama params */ }
    }
  },

  "operational_settings": {
    "inspiration_cards_count": 50,
    "batches_count": 20,
    "theme_prompt": "Epic fantasy with dragons and ancient magic",
    "complete_theme_override": null, // Or your full theme string
    "generate_basic_lands": true,
    "land_variations_per_type": 3,
    "rarities_per_batch": { "mythic": 1, "rare": 3, "uncommon": 4, "common": 5 },
    "color_distribution_targets": { "W": 0.2, "U": 0.2, "B": 0.2, "R": 0.2, "G": 0.2 }
  }
}
```

**Overriding Settings via Code (Optional):**

While most settings are in `settings.json`, you can still override some operational parameters like `theme_prompt` or `complete_theme_override` directly when instantiating the `Config` object in `card-generator/main.py` if needed for a specific run:

```python
# In card-generator/main.py
config = Config(
    csv_file_path="./assets/mtg_cards_english.csv", # Essential path
    # theme_prompt="A very specific theme for this run only",
    # complete_theme_override="""... full theme text ..."""
)
```
The system uses a strategy pattern internally to switch between different AI model providers (Replicate/Diffusers for images, OpenRouter/Ollama for language). The `strategy` fields in `settings.json` control which provider is used.


### Custom Theme Structure

When providing a `complete_theme_override`, your theme should include:

```
# Theme Title

## World Description
[Detailed description of the world/setting]

## Key Factions
[List and description of major factions/groups]

## Creature Types
[Common creature types in the set]

## Mechanical Themes
[Key gameplay mechanics and themes]

## Synergies
[How different card types and mechanics work together]

## Play Styles
[What play styles the set supports]
```

## Basic Land Generation

The system automatically generates variations of each basic land type:

- Plains, Island, Swamp, Mountain, and Forest
- Each type gets multiple artistic variations
- Land art is themed to match your set's aesthetic

You can configure:

- Whether to generate basic lands (`generate_basic_lands`)
- How many variations to create for each type (`land_variations_per_type`)

## Tabletop Simulator Integration

The project includes a TTS Deck Converter tool (`tts_deck_converter.py`) that arranges your generated card images into grid layouts compatible with Tabletop Simulator.

### TTS Converter Features

- Creates properly formatted card sheets for importing into Tabletop Simulator
- Automatically handles large sets by creating multiple sheets when needed
- Configurable grid dimensions, card sizes, and output quality
- Optional card sorting for easier organization

### Using the TTS Converter

```bash
cd card-generator
python tts_deck_converter.py
```

This will open a folder selector dialog. You can choose a directory containing your card images. The converter will then create a `tts_deck` folder with the following structure:

```
tts_deck/
├── deck_sheet_1.png
├── deck_sheet_2.png
├── deck_sheet_3.png
└── ...
```

Each sheet will contain a grid of card images, ready for import into Tabletop Simulator.

To import the deck sheets into Tabletop Simulator:

1. Open Tabletop Simulator
2. Create a new game
3. Click on "Objects" in the top menu
4. Select "Components" > "Cards" > "Custom Deck"
5. Select the first deck sheet image for front images
6. You can use `https://static.wikia.nocookie.net/mtgsalvation_gamepedia/images/f/f8/Magic_card_back.jpg/revision/latest` as the back image
7. Set the number of cards per row and column based on your grid size
8. Click "Import" to load the deck into your game
9. Repeat for each deck sheet

You can now play with your customer cards in tabletop simulator!

![tts.png](tts.png)

## Booster Draft Generator

The project includes a Booster Draft Generator that creates randomized booster packs from your generated sets for drafting in Tabletop Simulator.

### Using the Booster Generator

1. Launch the booster generator:
```bash
cd card-generator
python mtg-booster-generator.py
```

2. In the interface:
   - Select your MTG set folder
   - Set the number of boosters (1-100)
   - Click "Generate Boosters"

The generator creates:
- 15-card boosters with the correct rarity distribution (1 rare/mythic, 3 uncommons, 11 commons)
- Special boosters for each basic land type with all art variants
- All output saved in a `boosters` folder ready for use in Tabletop Simulator (see above for import instructions)

## Card Rendering Details

The card renderer supports:
- Standard MTG card frames
- Extended art frames
- Various card types (creatures, instants, sorceries, etc.)
- Multicolored cards
- Power/toughness boxes
- Set symbols
- Collector numbers
- Artist credits

## Acknowledgments

- Card rendering system based on [MTG Render](https://www.mtgrender.tk/) by Yoann 'Senryoku' Maret-Verdant
- Magic: The Gathering is a trademark of Wizards of the Coast LLC
- Card frame designs based on official MTG templates
- AI art generation powered by Replicate, Black Forest Labs, Stability AI (Stable Diffusion), and other models available via Hugging Face.
- Card generation powered by OpenRouter, OpenAI, and various models accessible via Ollama.

Special thanks to Yoann 'Senryoku' Maret-Verdant for creating the original MTG card renderer ([GitHub](https://github.com/Senryoku)) which forms the foundation of our card rendering system.